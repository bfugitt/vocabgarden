<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-serif { font-family: 'Merriweather', serif; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); } }
        .animate-glow { animation: pulse-glow 2s infinite; }
        
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }

        @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: pop-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 3s linear infinite; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }

        /* Flip Card */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { transition: transform 0.6s; }
        .flipped .card-inner { transform: rotateY(180deg); }

        /* Patterns */
        .bg-paper-pattern { background-image: radial-gradient(#d6d3d1 1px, transparent 1px); background-size: 20px 20px; }
        .bg-cork-pattern { background-color: #e7cba9; background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4a373' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1v1H5V0zM0 5h1v1H0V5z'/%3E%3C/g%3E%3C/svg%3E"); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f4; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #d6d3d1; border-radius: 20px; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 selection:bg-amber-100 min-h-screen flex flex-col">

    <main id="app" class="flex-grow flex flex-col items-center justify-center w-full p-4">
        <!-- Content injected here -->
    </main>

    <footer class="p-4 text-center text-stone-400 text-sm">
        <p>Vocabulary Garden â€¢ <span id="unit-count-display">0</span> Units Active</p>
    </footer>

    <script>
        // --- 1. DATA CONFIGURATION ---
        const CHOICE_COUNT = 4;

        const RAW_DATA = [
            // UNIT 1
            { u: 1, w: "celebrity", d: "A famous person.", s: "star, famous person", a: "unknown, nobody", ex: "The singer is a huge ______ with millions of fans.", pos: "noun" },
            { u: 1, w: "counsel", d: "To give advice; advice.", s: "advise, guidance", a: "ignore, disregard", ex: "The coach offered wise ______ on how to win the game.", pos: "verb" },
            { u: 1, w: "demonstrate", d: "To show clearly or explain.", s: "show, prove", a: "hide, conceal", ex: "Can you ______ how to solve that math problem?", pos: "verb" },
            { u: 1, w: "drowsy", d: "Feeling sleepy or tired.", s: "sleepy, tired", a: "alert, awake", ex: "The warm milk made the baby feel ______.", pos: "adjective" },
            { u: 1, w: "essential", d: "Completely necessary or important.", s: "necessary, vital", a: "unnecessary, optional", ex: "A helmet is ______ for riding a bike safely.", pos: "adjective" },
            { u: 1, w: "hardship", d: "A difficulty or trouble.", s: "difficulty, suffering", a: "ease, comfort", ex: "The pioneers faced many ______ during their journey.", pos: "noun" },
            { u: 1, w: "haul", d: "To pull or drag with effort.", s: "drag, pull", a: "push, carry lightly", ex: "We had to ______ the heavy logs up the hill.", pos: "verb" },
            { u: 1, w: "humble", d: "Not proud; modest; simple.", s: "modest, plain", a: "proud, arrogant", ex: "Despite his success, he remained a very ______ man.", pos: "adjective" },
            { u: 1, w: "pledge", d: "A serious promise.", s: "promise, vow", a: "break, deny", ex: "I made a ______ to always tell the truth.", pos: "noun" },
            
            // UNIT 2
            { u: 2, w: "annual", d: "Happening once a year.", s: "yearly, periodic", a: "daily, never", ex: "The town holds an ______ summer festival in July.", pos: "adjective" },
            { u: 2, w: "basic", d: "Simple or fundamental.", s: "simple, main", a: "complex, advanced", ex: "Learning to read is a ______ skill for life.", pos: "adjective" },
            { u: 2, w: "competition", d: "A contest or rivalry.", s: "contest, challenge", a: "cooperation, agreement", ex: "The two teams were in a tough ______ for the trophy.", pos: "noun" },
            { u: 2, w: "contract", d: "A written agreement.", s: "agreement, deal", a: "disagreement, breakup", ex: "They signed a ______ to buy the new house.", pos: "noun" },
            { u: 2, w: "dismiss", d: "To send away or let go.", s: "fire, let go", a: "hire, keep", ex: "The teacher had to ______ the student for bad behavior.", pos: "verb" },
            
            // UNIT 3: API TEST
            { u: 3, w: "ecosystem" }, { u: 3, w: "photosynthesis" }, { u: 3, w: "habitat" }, { u: 3, w: "predator" }, { u: 3, w: "organism" }, { u: 3, w: "species" }, { u: 3, w: "adaptation" }, { u: 3, w: "extinct" },

            // UNIT 4: Phonics
            { u: 4, w: "sickly" }, { u: 4, w: "hardly" }, { u: 4, w: "quickly" }, { u: 4, w: "slowly" }, { u: 4, w: "carefully" }, { u: 4, w: "wonderful" }, { u: 4, w: "beautiful" }, { u: 4, w: "graceful" }, { u: 4, w: "spoonful" }, { u: 4, w: "darkness" }, { u: 4, w: "shapeless" }, { u: 4, w: "ageless" }, { u: 4, w: "illness" }, { u: 4, w: "goodness" }, { u: 4, w: "spotless" }, { u: 4, w: "painless" }, { u: 4, w: "weakness" }, { u: 4, w: "darkest" }, { u: 4, w: "clearest" }, { u: 4, w: "thoughtful" }
        ];

        // --- 2. ICONS ---
        const ICONS = {
            arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>`,
            sprout: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 20h10"/><path d="M10 20c5.5-2.5.8-6.4 3-10"/><path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"/><path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z"/></svg>`,
            book: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>`,
            hammer: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H14.14c-.83 0-1.64.34-2.25.92L9.64 10"/></svg>`,
            leaf: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>`,
            layers: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>`,
            alignLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></svg>`,
            split: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></svg>`,
            message: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="currentColor" stroke="none"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
            cloud: `<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M17.5 19c0-1.7-1.3-3-3-3h-11c-1.7 0-3 1.3-3 3s1.3 3 3 3h11c1.7 0 3-1.3 3-3z"/><path d="M17.5 19a6 6 0 0 0-5-11.8A5.5 5.5 0 0 0 0 13"/></svg>`,
            award: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></svg>`,
            tag: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l5 5a2 2 0 0 0 2.828 0l7.172-7.172a2 2 0 0 0 0-2.828l-5-5z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>`,
            mic: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`,
            speaker: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`
        };

        const BADGE_COLORS = ['bg-red-200 text-red-900', 'bg-orange-200 text-orange-900', 'bg-amber-200 text-amber-900', 'bg-lime-200 text-lime-900', 'bg-green-200 text-green-900', 'bg-emerald-200 text-emerald-900', 'bg-teal-200 text-teal-900', 'bg-sky-200 text-sky-900', 'bg-blue-200 text-blue-900', 'bg-indigo-200 text-indigo-900', 'bg-violet-200 text-violet-900', 'bg-purple-200 text-purple-900', 'bg-fuchsia-200 text-fuchsia-900', 'bg-pink-200 text-pink-900', 'bg-rose-200 text-rose-900'];

        const State = {
            view: 'selection',
            activeUnits: [],
            pool: [],      
            queue: [],     
            completedGames: new Set(),
            gameQueues: {}, 
            gameTotals: {}, 
            badges: JSON.parse(localStorage.getItem('vocab_garden_badges')) || [],
            tempData: null, 
            feedback: null,
            isLoading: false
        };

        // Simplified Game List
        const GAMES_ORDER = ['sketchbook', 'echo', 'roots', 'order', 'workshop', 'greenhouse', 'path'];
        const GAME_INFO = {
            sketchbook: { title: 'Sketchbook', desc: 'Study cards', icon: ICONS.book, color: 'blue' },
            echo: { title: 'Echo Valley', desc: 'Hear & Say', icon: ICONS.mic, color: 'sky' },
            roots: { title: 'Roots', desc: 'Synonyms', icon: ICONS.split, color: 'purple' },
            order: { title: 'Order', desc: 'Alphabetize', icon: ICONS.alignLeft, color: 'blue' },
            workshop: { title: 'Workshop', desc: 'Build words', icon: ICONS.hammer, color: 'amber' },
            greenhouse: { title: 'Greenhouse', desc: 'Sort Types', icon: ICONS.tag, color: 'emerald' },
            path: { title: 'Garden Path', desc: 'Context & Meaning', icon: ICONS.layers, color: 'slate' }
        };

        const App = document.getElementById('app');
        const UnitDisplay = document.getElementById('unit-count-display');

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- API INTEGRATION ---
        async function fetchWordData(word) {
            try {
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (!res.ok) throw new Error('Not found');
                const data = await res.json();
                
                const entry = data[0];
                const allMeanings = entry.meanings;
                const allPos = [...new Set(allMeanings.map(m => m.partOfSpeech))].join(', ');
                
                const primaryMeaning = allMeanings[0];
                const primaryDef = primaryMeaning.definitions[0].definition;
                
                let richDefs = [];
                allMeanings.forEach(m => {
                    m.definitions.slice(0, 2).forEach(d => {
                        richDefs.push({ pos: m.partOfSpeech, text: d.definition });
                    });
                });
                
                const syns = [...new Set(allMeanings.flatMap(m => m.synonyms).concat(allMeanings.flatMap(m => m.definitions.flatMap(d => d.synonyms || []))))].slice(0, 5).join(', ');
                const ants = [...new Set(allMeanings.flatMap(m => m.antonyms).concat(allMeanings.flatMap(m => m.definitions.flatMap(d => d.antonyms || []))))].slice(0, 5).join(', ');

                let ex = null;
                for (let m of allMeanings) {
                    const defWithEx = m.definitions.find(d => d.example);
                    if (defWithEx) {
                        ex = defWithEx.example.replace(new RegExp(word, 'gi'), '______');
                        break;
                    }
                }

                // Audio
                const audioObj = entry.phonetics.find(p => p.audio && p.audio !== '');
                const audioUrl = audioObj ? audioObj.audio : null;

                return { d: primaryDef, s: syns || '-', a: ants || '-', ex: ex, pos: allPos, allDefs: richDefs, audio: audioUrl };
            } catch (e) {
                console.warn(`Could not fetch data for ${word}`, e);
                return null;
            }
        }

        async function hydratePool() {
            State.isLoading = true;
            render(); 

            const promises = State.pool.map(async (item) => {
                if (item.d && item.allDefs) return item; 
                // Manual defs needing enrichment
                if (item.d && !item.allDefs) {
                    item.allDefs = [{ pos: item.pos || 'unknown', text: item.d }];
                    return item;
                }

                const apiData = await fetchWordData(item.w);
                if (apiData) return { ...item, ...apiData };
                
                return { 
                    ...item, 
                    d: "Definition unavailable.", 
                    s: "-", a: "-", pos: "noun", 
                    allDefs: [{ pos: 'unknown', text: "Definition unavailable." }] 
                };
            });

            State.pool = await Promise.all(promises);
            State.isLoading = false;
            State.completedGames.clear();
            State.gameQueues = {};
            State.gameTotals = {};
            State.view = 'menu';
            render();
        }

        // --- NAVIGATION ---
        function initGame(viewId) {
            State.view = viewId;
            State.tempData = null;
            State.feedback = null;

            if (State.gameQueues[viewId] && State.gameQueues[viewId].length === 0) State.gameQueues[viewId] = null; 

            if (!State.gameQueues[viewId]) {
                let newQueue = [];
                if (viewId === 'roots') {
                    newQueue = State.pool.filter(i => (i.s && i.s !== 'void' && i.s !== '-') || (i.a && i.a !== 'void' && i.a !== '-'));
                } else if (viewId === 'greenhouse') {
                    newQueue = State.pool.filter(i => i.pos);
                } else if (viewId === 'echo') {
                    newQueue = State.pool.filter(i => i.audio);
                } else {
                    newQueue = [...State.pool];
                }
                State.gameQueues[viewId] = shuffle(newQueue);
                State.gameTotals[viewId] = newQueue.length;
            }
            State.queue = State.gameQueues[viewId]; 
            render();
        }

        function checkVictory() {
            if (State.queue.length === 0) {
                if (State.view !== 'victory') State.completedGames.add(State.view);
                State.view = 'victory';
                render();
                return true;
            }
            return false;
        }
        
        function updatePersistentQueue() {
            if (!['victory','menu','selection','loading'].includes(State.view)) {
                State.gameQueues[State.view] = State.queue;
            }
        }

        function render() {
            UnitDisplay.innerText = State.activeUnits.length;
            App.innerHTML = ''; 
            if (State.isLoading) { renderLoading(); return; }

            switch(State.view) {
                case 'selection': renderSelection(); break;
                case 'menu': renderMenu(); break;
                case 'victory': renderVictory(); break;
                case 'grand_victory': renderGrandVictory(); break;
                
                case 'sketchbook': renderSketchbook(); break;
                case 'workshop': renderWorkshop(); break;
                case 'path': renderGardenPath(); break; // Merged
                case 'order': renderOrder(); break;
                case 'roots': renderRoots(); break;
                case 'greenhouse': renderGreenhouse(); break;
                case 'echo': renderEchoValley(); break; // New
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderLoading() {
            App.innerHTML = `<div class="flex flex-col items-center justify-center h-64 w-full animate-fadeIn"><div class="mb-4 text-green-600 animate-spin-slow">${ICONS.sun}</div><h2 class="text-xl font-serif text-stone-700">Watering the seeds...</h2><p class="text-stone-400 text-sm mt-2">Gathering definitions from the library.</p></div>`;
        }

        function renderSelection() {
            const units = [...new Set(RAW_DATA.map(i => i.u))].sort((a,b) => String(a).localeCompare(String(b), undefined, {numeric: true}));
            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center min-h-[60vh] w-full max-w-2xl mx-auto animate-fadeIn pb-10";
            
            div.innerHTML = `
                <div class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-serif text-stone-800 mb-2">Vocabulary Garden</h1><p class="text-stone-500 italic">Open the gate to begin.</p></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200 w-full mb-8">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-stone-100"><h2 class="text-lg font-bold text-stone-700">Select Collections</h2><button id="btn-toggle-all" class="text-sm text-green-600 font-medium hover:text-green-800">${State.activeUnits.length === units.length ? "Deselect All" : "Select All"}</button></div>
                    <div id="unit-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
                <button id="btn-start" class="px-8 py-3 rounded-full font-bold text-lg shadow-md transition-all flex items-center gap-2 ${State.activeUnits.length > 0 ? 'bg-green-700 text-white hover:bg-green-800 hover:scale-105' : 'bg-stone-200 text-stone-400 cursor-not-allowed'}">Enter Garden ${ICONS.arrowRight}</button>
                ${State.badges.length > 0 ? `<div class="w-full mt-12"><h3 class="text-center text-stone-400 text-sm uppercase tracking-widest mb-4">Achievements</h3><div class="bg-cork-pattern p-6 rounded-xl border-8 border-stone-300 shadow-inner flex flex-wrap gap-4 justify-center items-start min-h-[120px]">${State.badges.map(b => `<div class="flex flex-col items-center animate-pop-in" title="${b.timestamp}"><div class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-2 border-white/50 ${b.color}">${ICONS.award}</div><div class="bg-white/90 px-2 py-0.5 rounded text-[10px] font-bold mt-1 shadow-sm text-stone-600 min-w-[30px] text-center">${b.label}</div></div>`).join('')}</div><div class="text-center mt-2"><button id="btn-clear-badges" class="text-xs text-stone-400 hover:text-red-400 underline">Clear Board</button></div></div>` : ''}
            `;

            const list = div.querySelector('#unit-list');
            units.forEach(u => {
                const isSelected = State.activeUnits.includes(u);
                const btn = document.createElement('button');
                btn.className = `flex items-center p-3 rounded-lg text-left transition-all border-2 w-full ${isSelected ? 'bg-green-50 border-green-500 text-green-900' : 'bg-stone-50 border-transparent hover:bg-stone-100 text-stone-600'}`;
                const unitLabel = typeof u === 'string' && u.includes(':') ? u.split(':')[0] : `Unit ${u}`;
                btn.innerHTML = `<div class="w-5 h-5 rounded border mr-3 flex items-center justify-center transition-colors ${isSelected ? 'bg-green-500 border-green-500' : 'border-stone-300 bg-white'}">${isSelected ? `<span class="text-white">${ICONS.check}</span>` : ''}</div><span class="text-sm font-medium truncate">${u}</span>`;
                btn.onclick = () => { if (isSelected) State.activeUnits = State.activeUnits.filter(x => x !== u); else State.activeUnits.push(u); render(); };
                list.appendChild(btn);
            });

            div.querySelector('#btn-start').onclick = () => { if (State.activeUnits.length === 0) return; State.pool = RAW_DATA.filter(item => State.activeUnits.includes(item.u)); hydratePool(); };
            div.querySelector('#btn-toggle-all').onclick = () => { if (State.activeUnits.length === units.length) State.activeUnits = []; else State.activeUnits = [...units]; render(); };
            if (State.badges.length > 0) div.querySelector('#btn-clear-badges').onclick = () => { if(confirm("Clear all?")) { State.badges = []; localStorage.removeItem('vocab_garden_badges'); render(); }};
            App.appendChild(div);
        }

        function renderMenu() {
            if (State.completedGames.size === GAMES_ORDER.length) { renderGrandVictory(); return; }
            const suggestedGame = GAMES_ORDER.find(id => !State.completedGames.has(id));
            const completionPct = Math.round((State.completedGames.size / GAMES_ORDER.length) * 100);
            const gardenLevel = Math.floor((completionPct / 100) * 5);

            const div = document.createElement('div');
            div.className = "flex flex-col items-center w-full max-w-5xl mx-auto animate-fadeIn";
            div.innerHTML = `
                <div class="w-full flex justify-start mb-2"><button id="btn-back-units" class="text-stone-400 hover:text-stone-600 text-sm flex items-center gap-1">${ICONS.arrowLeft} Select different units</button></div>
                <header class="text-center mb-6 w-full"><h1 class="text-4xl font-serif text-stone-800 mb-1">The Garden</h1><p class="text-stone-500 italic text-sm">Choose a path to explore.</p></header>
                <div class="w-full bg-gradient-to-b from-sky-50 to-white border border-stone-200 rounded-3xl p-6 mb-8 shadow-sm relative overflow-hidden h-40">
                    <div class="absolute top-4 right-4 text-yellow-400 animate-pulse-slow">${ICONS.sun}</div><div class="absolute top-6 left-10 text-sky-100">${ICONS.cloud}</div>
                    <div class="flex flex-col items-center justify-end h-full relative z-10 pb-2">
                        <div class="flex items-end gap-3 mb-2" id="plant-container"></div>
                        <div class="w-64 h-3 bg-stone-200 rounded-full overflow-hidden"><div class="h-full bg-green-500 transition-all duration-500" style="width: ${completionPct}%"></div></div>
                        <p class="mt-2 text-stone-600 font-bold text-xs">${State.completedGames.size} of ${GAMES_ORDER.length} Activities Complete</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full" id="menu-grid"></div>
            `;

            const plantCont = div.querySelector('#plant-container');
            for(let i=0; i<5; i++) {
                const p = document.createElement('div');
                const isGrown = i < gardenLevel;
                p.className = `transition-all duration-1000 ${isGrown ? 'opacity-100 translate-y-0 text-green-600' : 'opacity-20 translate-y-8 scale-50 text-green-300'}`;
                p.innerHTML = ICONS.sprout;
                plantCont.appendChild(p);
            }

            const grid = div.querySelector('#menu-grid');
            GAMES_ORDER.forEach(id => {
                const info = GAME_INFO[id];
                const isComplete = State.completedGames.has(id);
                const isSuggested = id === suggestedGame;
                let pct = 0;
                if (State.gameQueues[id] && State.gameTotals[id] > 0) pct = Math.round(((State.gameTotals[id] - State.gameQueues[id].length) / State.gameTotals[id]) * 100);
                else if (isComplete) pct = 100;

                const btn = document.createElement('button');
                let classes = `group relative bg-white rounded-2xl p-4 shadow-sm border-2 transition-all text-left flex flex-col h-36 justify-between overflow-hidden`;
                if (isComplete) classes += ` border-green-200 bg-green-50/20`; 
                else if (isSuggested) classes += ` border-amber-400 ring-4 ring-amber-100 ring-offset-2 animate-glow shadow-md transform scale-105 z-10`; 
                else classes += ` border-stone-100 hover:border-${info.color}-200 hover:shadow-md`;

                btn.className = classes;
                btn.innerHTML = `
                    <div class="absolute -right-4 -top-4 bg-${info.color}-50 w-20 h-20 rounded-full transition-transform group-hover:scale-150"></div>
                    <div class="z-10 bg-${info.color}-100 w-10 h-10 rounded-lg flex items-center justify-center text-${info.color}-700 mb-2">${isComplete ? ICONS.check : info.icon}</div>
                    <div class="z-10 w-full"><h3 class="text-base font-bold text-stone-800 mb-0 leading-tight flex items-center gap-2">${info.title}${isSuggested ? '<span class="text-[10px] bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded-full uppercase tracking-wide">Next</span>' : ''}</h3><p class="text-xs text-stone-500 mb-2">${isComplete ? 'Play Again' : info.desc}</p><div class="w-full h-1.5 bg-stone-100 rounded-full overflow-hidden"><div class="h-full bg-${isComplete ? 'green' : info.color}-500 transition-all duration-500" style="width: ${pct}%"></div></div></div>
                `;
                btn.onclick = () => initGame(id);
                grid.appendChild(btn);
            });
            div.querySelector('#btn-back-units').onclick = () => { State.view = 'selection'; render(); };
            App.appendChild(div);
        }

        function renderVictory() {
            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center text-center p-8 animate-fadeIn max-w-md mx-auto";
            div.innerHTML = `<div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-6 animate-pulse-slow">${ICONS.sprout}</div><h2 class="text-3xl font-serif text-stone-800 mb-2">Activity Complete!</h2><p class="text-stone-500 mb-8">You have tended this part of the garden. Ready for the next step?</p><button id="back-btn" class="px-8 py-3 bg-green-700 text-white rounded-full font-bold shadow-md hover:bg-green-800 transition-all flex items-center gap-2">${ICONS.arrowLeft} Return to Map</button>`;
            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            App.appendChild(div);
        }

        function renderGrandVictory() {
            const numbers = State.activeUnits.map(u => {
                if (typeof u === 'number') return u;
                const m = String(u).match(/\d+/);
                return m ? parseInt(m[0]) : u.substring(0,3);
            }).sort((a,b) => a-b).join(', ');
            const color = BADGE_COLORS[Math.floor(Math.random() * BADGE_COLORS.length)];
            const newBadge = { id: Date.now(), label: numbers, color: color, timestamp: new Date().toLocaleDateString() };
            State.badges.push(newBadge);
            localStorage.setItem('vocab_garden_badges', JSON.stringify(State.badges));

            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center text-center p-8 animate-fadeIn max-w-2xl mx-auto min-h-[50vh]";
            div.innerHTML = `<div class="relative w-40 h-40 mb-8 animate-pop-in"><div class="absolute inset-0 rounded-full flex items-center justify-center shadow-xl border-4 border-white ${color}">${ICONS.award.replace('width="48"', 'width="80"').replace('height="48"', 'height="80"')}</div><div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 bg-white px-4 py-1 rounded-full shadow-lg border-2 border-stone-100 font-bold text-stone-700 text-lg whitespace-nowrap">Unit ${numbers}</div></div><h1 class="text-4xl md:text-5xl font-serif text-stone-800 mb-4">Master Gardener!</h1><p class="text-xl text-stone-600 mb-8 leading-relaxed max-w-lg">You have earned a new badge for your collection! The garden is now in full bloom.</p><div class="flex flex-col sm:flex-row gap-4"><button id="btn-restart-activities" class="px-8 py-3 bg-stone-100 text-stone-600 rounded-full font-bold hover:bg-stone-200 transition-all">Do Activities Again</button><button id="btn-new-units" class="px-8 py-3 bg-green-700 text-white rounded-full font-bold shadow-lg hover:bg-green-800 hover:scale-105 transition-all flex items-center justify-center gap-2">Select New Units ${ICONS.arrowRight}</button></div>`;
            div.querySelector('#btn-restart-activities').onclick = () => { State.completedGames.clear(); State.gameQueues = {}; State.view = 'menu'; render(); };
            div.querySelector('#btn-new-units').onclick = () => { State.view = 'selection'; render(); };
            App.appendChild(div);
        }

        // --- NEW & UPDATED GAMES ---

        // NEW: ECHO VALLEY (Say and Hear)
        function renderEchoValley() {
            if (checkVictory()) return;
            const item = State.queue[0];
            
            if (!State.tempData || State.tempData.word !== item.w) {
                State.tempData = { word: item.w, stage: 1 }; // 1=Say, 2=Listen/Repeat
            }

            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center w-full animate-fadeIn min-h-[50vh]";
            
            const stage1 = `
                <h2 class="text-6xl font-serif text-stone-800 mb-8 font-bold tracking-tight">${item.w}</h2>
                <div class="text-stone-500 mb-8 flex items-center gap-2"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg> Read it aloud!</div>
                <button id="btn-reveal" class="px-8 py-4 bg-sky-500 text-white text-xl rounded-full shadow-lg hover:bg-sky-600 transition-all font-bold">Check Pronunciation</button>
            `;

            const stage2 = `
                <h2 class="text-6xl font-serif text-stone-800 mb-8 font-bold tracking-tight">${item.w}</h2>
                <div class="flex gap-4 mb-8">
                    <button id="btn-play" class="w-20 h-20 bg-sky-100 rounded-full flex items-center justify-center text-sky-600 shadow-md hover:scale-110 transition-transform ring-4 ring-sky-50">
                        ${ICONS.speaker}
                    </button>
                </div>
                <p class="text-stone-500 mb-8">Listen, then say it again.</p>
                <button id="btn-next" class="px-8 py-4 bg-green-600 text-white text-xl rounded-full shadow-lg hover:bg-green-700 transition-all font-bold flex items-center gap-2">Next Word ${ICONS.arrowRight}</button>
            `;

            div.innerHTML = `
                <div class="flex justify-between w-full max-w-lg mb-10"><button id="back-btn" class="text-stone-400 hover:text-stone-600 flex items-center gap-1">${ICONS.arrowLeft} Garden</button><span class="bg-sky-100 text-sky-800 px-3 py-1 rounded-full text-xs font-bold tracking-wider">ECHO VALLEY</span></div>
                ${State.tempData.stage === 1 ? stage1 : stage2}
            `;

            if (State.tempData.stage === 1) {
                div.querySelector('#btn-reveal').onclick = () => {
                    State.tempData.stage = 2;
                    // Auto play
                    if (item.audio) new Audio(item.audio).play();
                    render();
                };
            } else {
                div.querySelector('#btn-play').onclick = () => {
                    if (item.audio) new Audio(item.audio).play();
                };
                div.querySelector('#btn-next').onclick = () => {
                    State.queue.shift();
                    updatePersistentQueue();
                    State.tempData = null;
                    checkVictory() || render();
                };
            }

            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            App.appendChild(div);
        }

        // UPDATED: GREENHOUSE (Select & Sort, 4 items)
        function renderGreenhouse() {
            if (checkVictory()) return;
            
            // Need a batch of up to 4 words
            if (!State.tempData || !State.tempData.batch) {
                // Take up to 4 from the queue
                const batch = State.queue.slice(0, 4);
                State.tempData = { batch: batch, selected: null };
            }

            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-start w-full animate-fadeIn";
            div.innerHTML = `
                <div class="flex items-center justify-between w-full max-w-3xl mb-4"><button id="back-btn" class="flex items-center text-stone-600 hover:text-stone-800">${ICONS.arrowLeft} Garden</button><span class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-xs font-bold tracking-wider">GREENHOUSE</span></div>
                
                <p class="text-stone-500 italic mb-6">Select a seedling, then tap its pot.</p>

                <!-- SEEDLINGS (Words) -->
                <div class="flex flex-wrap justify-center gap-4 mb-10 min-h-[80px]">
                    ${State.tempData.batch.map(item => `
                        <button id="seed-${item.w}" class="px-6 py-3 rounded-full border-2 font-bold text-lg shadow-sm transition-all ${State.tempData.selected === item ? 'bg-emerald-500 text-white border-emerald-500 scale-110 shadow-lg ring-4 ring-emerald-100' : 'bg-white border-stone-200 text-stone-700 hover:border-emerald-300'} animate-float">
                            ${item.w}
                        </button>
                    `).join('')}
                </div>
                
                <!-- POTS -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full max-w-4xl px-4">
                    ${['noun', 'verb', 'adjective', 'adverb'].map(pos => `
                        <button id="pot-${pos}" class="group relative flex flex-col items-center p-4 rounded-2xl border-b-8 border-stone-200 bg-white transition-all active:scale-95 active:border-b-4">
                            <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-2 text-stone-400 group-hover:text-emerald-500 group-hover:bg-emerald-50 transition-colors">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2L2 22h20L12 2zm0 4.8l6.4 12.8H5.6L12 6.8z"/></svg>
                            </div>
                            <span class="text-sm font-bold text-stone-600 uppercase tracking-widest">${pos}</span>
                        </button>
                    `).join('')}
                </div>
                
                <div id="feedback-msg" class="fixed bottom-10 px-6 py-3 rounded-full text-white font-bold shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>
            `;

            // Bind Seedlings
            State.tempData.batch.forEach(item => {
                div.querySelector(`#seed-${item.w}`).onclick = () => {
                    State.tempData.selected = item;
                    render(); // Re-render to show selection highlight
                };
            });

            // Bind Pots
            ['noun', 'verb', 'adjective', 'adverb'].forEach(pos => {
                div.querySelector(`#pot-${pos}`).onclick = () => {
                    const item = State.tempData.selected;
                    if (!item) return; // Nothing selected

                    const msg = div.querySelector('#feedback-msg');
                    const correctPos = (item.pos || '').toLowerCase();
                    const isCorrect = correctPos.includes(pos); 

                    if (isCorrect) {
                        // Success Animation
                        const seedBtn = div.querySelector(`#seed-${item.w}`);
                        seedBtn.classList.add('scale-0', 'opacity-0'); // Poof
                        
                        // Remove from batch
                        State.tempData.batch = State.tempData.batch.filter(i => i !== item);
                        State.tempData.selected = null;
                        
                        // Remove from main queue
                        State.queue = State.queue.filter(i => i !== item);
                        updatePersistentQueue();

                        if (State.tempData.batch.length === 0 && State.queue.length > 0) {
                            // Replenish batch
                            State.tempData.batch = State.queue.slice(0, 4);
                        } else if (State.queue.length === 0) {
                            checkVictory();
                        }
                        
                        // Render with slight delay to show animation
                        setTimeout(() => checkVictory() || render(), 300);

                    } else {
                        msg.className = "fixed bottom-10 bg-amber-600 px-6 py-3 rounded-full text-white font-bold shadow-lg animate-shake opacity-100 translate-y-0";
                        msg.innerHTML = `Not a ${pos}. Try again!`; 
                        setTimeout(() => {
                            msg.className = "fixed bottom-10 px-6 py-3 rounded-full text-white font-bold shadow-lg transform translate-y-20 opacity-0 transition-all duration-300";
                        }, 1500);
                    }
                };
            });

            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            App.appendChild(div);
        }

        // MERGED: GARDEN PATH (Context & Meaning)
        function renderGardenPath() {
            if (checkVictory()) return;
            const target = State.queue[0];

            if (!State.tempData || State.tempData.word !== target.w) {
                const distractors = State.pool.filter(i => i.w !== target.w).sort(() => 0.5 - Math.random()).slice(0, CHOICE_COUNT - 1);
                const opts = [...distractors, target].sort(() => 0.5 - Math.random());
                
                // Determine Mode: Sentence (if available) vs Definition
                const mode = (target.ex && Math.random() > 0.3) ? 'sentence' : 'def'; // 70% sentence if avail
                
                State.tempData = { word: target.w, options: opts, mode: mode };
                State.feedback = null;
            }

            const promptText = State.tempData.mode === 'sentence' ? `"${target.ex}"` : `"${target.d}"`;
            const subText = State.tempData.mode === 'sentence' ? 'Fill in the stone' : 'Find the word';

            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-start w-full animate-fadeIn";
            div.innerHTML = `
                <div class="flex items-center justify-between w-full max-w-2xl mb-8"><button id="back-btn" class="flex items-center text-stone-600 hover:text-stone-800">${ICONS.arrowLeft} Garden</button><span class="bg-slate-100 text-slate-800 px-3 py-1 rounded-full text-xs font-bold tracking-wider">GARDEN PATH</span></div>
                
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-stone-200 w-full max-w-2xl text-center mb-10 relative">
                    <div class="absolute top-0 left-0 w-full h-2 bg-slate-400 rounded-t-2xl"></div>
                    <span class="text-stone-400 text-xs uppercase tracking-widest mb-2 block">${subText}</span>
                    <p class="text-2xl text-stone-700 font-serif leading-relaxed">${promptText}</p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl" id="opts-container"></div>
            `;

            const optsContainer = div.querySelector('#opts-container');
            State.tempData.options.forEach(opt => {
                const btn = document.createElement('button');
                const isCorrect = opt.w === target.w;
                let cls = "bg-white border-stone-200 hover:border-slate-400";
                
                if (State.feedback) {
                    if (State.feedback.clicked === opt) cls = isCorrect ? "bg-green-600 text-white border-green-600 scale-105 shadow-lg" : "bg-red-50 border-red-300 text-red-800 animate-shake";
                    else if (isCorrect && State.feedback.clicked !== opt) cls = "bg-green-100 border-green-300 opacity-70";
                    else cls = "opacity-50";
                }

                btn.className = `p-6 rounded-2xl border-2 shadow-sm text-center transition-all font-bold text-lg ${cls}`;
                btn.innerText = opt.w;
                
                btn.onclick = () => {
                    if (State.feedback) return;
                    State.feedback = { clicked: opt };
                    render();
                    
                    if (isCorrect) {
                        setTimeout(() => { 
                            State.queue.shift(); 
                            updatePersistentQueue(); 
                            State.tempData = null; 
                            checkVictory() || render(); 
                        }, 1500);
                    } else { 
                        // WRONG: Wait, Show, Move to Back
                        setTimeout(() => { 
                            const moved = State.queue.shift();
                            State.queue.push(moved);
                            updatePersistentQueue();
                            State.tempData = null; 
                            State.feedback = null;
                            render(); 
                        }, 2000); 
                    }
                };
                optsContainer.appendChild(btn);
            });
            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            App.appendChild(div);
        }

        // --- OLD GAMES (Standard renders) ---

        // A. Sketchbook
        function renderSketchbook() {
            if (State.queue.length === 0) { checkVictory(); return; }
            const item = State.queue[0];
            const isFlipped = State.feedback === true;
            const unitLabel = String(item.u).includes(':') ? String(item.u).split(':')[0] : `Unit ${item.u}`;

            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center w-full animate-fadeIn";
            div.innerHTML = `
                <div class="flex items-center justify-between w-full max-w-md mb-6"><button id="back-btn" class="flex items-center text-stone-600 hover:text-stone-800 transition-colors">${ICONS.arrowLeft} Garden</button><span class="text-stone-500 font-serif italic">${State.queue.length} seeds left</span></div>
                <div id="card-container" class="cursor-pointer group perspective-1000 w-full max-w-md h-96 relative ${isFlipped ? 'flipped' : ''}">
                    <div class="card-inner relative w-full h-full transform-style-3d">
                        <!-- FRONT -->
                        <div class="absolute w-full h-full backface-hidden bg-white rounded-xl shadow-lg border-2 border-stone-200 flex flex-col items-center justify-center p-8 bg-paper-pattern">
                            <span class="text-stone-400 text-xs absolute top-4 right-4 uppercase tracking-wider truncate max-w-[150px]">${unitLabel}</span><h2 class="text-4xl text-stone-800 font-serif font-medium tracking-wide text-center">${item.w}</h2><div class="mt-8 text-stone-400 text-sm flex items-center gap-2">${ICONS.refresh} Tap to reveal</div>
                        </div>
                        <!-- BACK (RICH DEFS) -->
                        <div class="absolute w-full h-full backface-hidden bg-stone-50 rounded-xl shadow-lg border-2 border-stone-300 flex flex-col p-6 rotate-y-180 bg-paper-pattern overflow-y-auto custom-scrollbar">
                            <span class="text-stone-400 text-xs absolute top-4 right-4">Definition</span>
                            <div class="mt-6 space-y-4 text-left">
                                ${item.allDefs && item.allDefs.length > 0 
                                    ? item.allDefs.map(def => `
                                        <div>
                                            <span class="text-xs font-bold uppercase text-stone-400 tracking-wider">${def.pos}</span>
                                            <p class="text-stone-700 font-medium leading-snug">${def.text}</p>
                                        </div>
                                    `).join('')
                                    : `<p class="text-xl text-stone-700 text-center font-medium leading-relaxed mb-6">"${item.d}"</p>`
                                }
                            </div>
                            <div class="w-full grid grid-cols-2 gap-4 mt-6 border-t-2 border-dashed border-stone-200 pt-4 shrink-0">
                                <div class="text-center"><span class="block text-xs uppercase tracking-widest text-stone-400 mb-1">Synonym</span><span class="text-stone-600 font-serif italic">${item.s || '-'}</span></div>
                                <div class="text-center"><span class="block text-xs uppercase tracking-widest text-stone-400 mb-1">Antonym</span><span class="text-stone-600 font-serif italic">${item.a || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8 w-full max-w-md">
                    <button id="btn-again" class="flex-1 py-3 px-6 rounded-lg border-2 border-stone-300 text-stone-500 font-bold hover:bg-stone-100 transition-colors">Shuffle</button>
                    <button id="btn-gotit" class="flex-1 py-3 px-6 rounded-lg bg-green-700/90 text-white font-bold shadow-md hover:bg-green-800 hover:shadow-lg transition-all flex items-center justify-center gap-2">${ICONS.check} Got it!</button>
                </div>
            `;
            div.querySelector('#card-container').onclick = () => { State.feedback = !State.feedback; render(); };
            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            div.querySelector('#btn-again').onclick = (e) => { 
                e.stopPropagation(); 
                State.feedback = false; 
                State.queue.push(State.queue.shift()); 
                render(); 
            };
            div.querySelector('#btn-gotit').onclick = (e) => { 
                e.stopPropagation(); 
                State.feedback = false; 
                State.queue.shift(); 
                updatePersistentQueue(); 
                if(!checkVictory()) render(); 
            };
            App.appendChild(div);
        }

        // B. Workshop
        function renderWorkshop() {
            if (checkVictory()) return;
            const item = State.queue[0];

            if (!State.tempData || State.tempData.word !== item.w) {
                const w = item.w;
                const letters = w.split('').map((l, i) => ({ val: l, id: i }));
                for (let i = letters.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [letters[i], letters[j]] = [letters[j], letters[i]]; }
                State.tempData = { word: w, shuffled: letters, placed: Array(w.length).fill(null) };
                State.feedback = null;
            }

            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-start w-full animate-fadeIn";
            div.innerHTML = `
                <div class="flex items-center justify-between w-full max-w-lg mb-8"><button id="back-btn" class="flex items-center text-stone-600 hover:text-stone-800">${ICONS.arrowLeft} Garden</button><span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs font-bold tracking-wider">WORKSHOP</span></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200 w-full max-w-lg text-center mb-8"><p class="text-xl text-stone-800 font-medium leading-relaxed">"${item.d}"</p></div>
                <div class="flex flex-wrap justify-center gap-2 mb-10 ${State.feedback === false ? 'animate-shake' : ''}" id="slots-area"></div>
                <div class="flex flex-wrap justify-center gap-2 max-w-lg" id="tiles-area"></div>
                ${State.feedback === true ? `<div class="fixed bottom-10 bg-green-600 text-white px-6 py-2 rounded-full shadow-lg flex items-center gap-2 animate-bounce">${ICONS.check} Built!</div>` : ''}
                ${State.feedback === false ? `<div class="fixed bottom-10 bg-amber-600 text-white px-6 py-2 rounded-full shadow-lg flex items-center gap-2 animate-bounce">Spelling: ${item.w}</div>` : ''}
            `;

            const slotsArea = div.querySelector('#slots-area');
            State.tempData.placed.forEach((l, i) => {
                const btn = document.createElement('button');
                btn.className = `w-10 h-12 rounded-lg flex items-center justify-center text-xl font-bold shadow-inner border-2 transition-all ${l ? (State.feedback===true ? 'bg-green-100 border-green-300 text-green-700' : State.feedback===false ? 'bg-red-50 border-red-300 text-red-800' : 'bg-stone-100 border-stone-300 text-stone-800') : 'bg-stone-50 border-stone-200 border-dashed'}`;
                btn.innerText = l ? l.val : '';
                btn.onclick = () => { if (State.feedback !== null || !l) return; State.tempData.shuffled.push(l); State.tempData.placed[i] = null; render(); };
                slotsArea.appendChild(btn);
            });

            const tilesArea = div.querySelector('#tiles-area');
            State.tempData.shuffled.forEach((l) => {
                const btn = document.createElement('button');
                btn.className = "w-10 h-12 bg-amber-200 rounded-lg shadow-sm border-t border-amber-100 flex items-center justify-center text-xl font-bold text-amber-900 active:translate-y-1 transition-transform";
                btn.innerText = l.val;
                btn.onclick = () => {
                    if (State.feedback !== null) return;
                    const firstEmpty = State.tempData.placed.indexOf(null);
                    if (firstEmpty !== -1) {
                        State.tempData.placed[firstEmpty] = l;
                        State.tempData.shuffled = State.tempData.shuffled.filter(x => x.id !== l.id);
                        if (State.tempData.placed.indexOf(null) === -1) {
                            if (State.tempData.placed.map(x => x.val).join('') === item.w) {
                                State.feedback = true; 
                                setTimeout(() => { State.queue.shift(); updatePersistentQueue(); State.tempData = null; checkVictory() || render(); }, 1500);
                            } else { 
                                State.feedback = false; render();
                                setTimeout(() => { const moved = State.queue.shift(); State.queue.push(moved); updatePersistentQueue(); State.tempData = null; State.feedback = null; render(); }, 2000); 
                            }
                        }
                        render();
                    }
                };
                tilesArea.appendChild(btn);
            });

            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            App.appendChild(div);
        }

        // E. Order
        function renderOrder() {
             if (checkVictory()) return;
             if (!State.tempData) {
                 if (State.queue.length < 2) { State.queue = []; checkVictory(); return; }
                const round = State.queue.slice(0, 5);
                const correctOrder = [...round].sort((a,b) => a.w.localeCompare(b.w));
                State.tempData = { items: round, correctOrder: correctOrder, foundCount: 0, error: false };
             }
             const div = document.createElement('div');
             div.className = "flex flex-col items-center h-full w-full p-4 animate-fadeIn";
             div.innerHTML = `
                <div class="flex items-center justify-between w-full max-w-lg mb-8"><button id="back-btn" class="flex items-center text-stone-600 hover:text-stone-800">${ICONS.arrowLeft} Garden</button><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold tracking-wider">ORDER</span></div>
                <p class="text-stone-500 italic mb-6">Select the words in alphabetical order.</p>
                <div class="w-full max-w-lg bg-stone-100 rounded-xl p-4 min-h-[80px] flex flex-wrap gap-2 mb-8 border-b-4 border-stone-200 shadow-inner" id="shelf"></div>
                <div class="flex flex-wrap justify-center gap-4 max-w-lg ${State.tempData.error ? 'animate-shake' : ''}" id="pool"></div>
             `;
             const shelf = div.querySelector('#shelf');
             for(let i=0; i<State.tempData.foundCount; i++) {
                 const badge = document.createElement('div');
                 badge.className = "px-4 py-2 bg-green-600 text-white rounded-lg shadow-sm font-bold";
                 badge.innerText = State.tempData.correctOrder[i].w;
                 shelf.appendChild(badge);
             }
             const poolDiv = div.querySelector('#pool');
             State.tempData.items.forEach(item => {
                 const correctIndex = State.tempData.correctOrder.indexOf(item);
                 if (correctIndex < State.tempData.foundCount) return;
                 const btn = document.createElement('button');
                 btn.className = "px-6 py-3 bg-white border-2 border-stone-200 rounded-xl shadow-sm text-stone-700 font-bold text-lg hover:border-blue-300 hover:-translate-y-1 transition-all";
                 btn.innerText = item.w;
                 btn.onclick = () => {
                     const nextCorrect = State.tempData.correctOrder[State.tempData.foundCount];
                     if (item.w === nextCorrect.w) {
                         State.tempData.foundCount++;
                         if (State.tempData.foundCount === State.tempData.items.length) {
                             State.queue = State.queue.slice(State.tempData.items.length); updatePersistentQueue(); setTimeout(() => { State.tempData = null; checkVictory() || render(); }, 1500);
                         }
                         render();
                     } else { State.tempData.error = true; render(); setTimeout(() => { State.tempData.error = false; render(); }, 500); }
                 };
                 poolDiv.appendChild(btn);
             });
             div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
             App.appendChild(div);
        }

        // F. Roots
        function renderRoots() {
            if (checkVictory()) return;
            const target = State.queue[0];
            if (!State.tempData || State.tempData.word !== target.w) {
                 let mode = 'syn';
                 if (target.a && target.a !== 'void' && target.a !== '-') {
                     if ((!target.s || target.s === 'void' || target.s === '-') || Math.random() > 0.5) mode = 'ant';
                 }
                 const correct = mode === 'syn' ? target.s : target.a;
                 const distractors = State.pool.filter(i => i.w !== target.w).sort(() => 0.5 - Math.random()).slice(0, CHOICE_COUNT - 1).map(i => i.w);
                 const opts = [...distractors, correct].sort(() => 0.5 - Math.random());
                 State.tempData = { mode: mode, word: target.w, correct: correct, options: opts, feedback: null };
            }
            const div = document.createElement('div');
            div.className = "flex flex-col items-center h-full w-full p-4 animate-fadeIn";
            div.innerHTML = `
                <div class="flex items-center justify-between w-full max-w-lg mb-8"><button id="back-btn" class="flex items-center text-stone-600 hover:text-stone-800">${ICONS.arrowLeft} Garden</button><span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold tracking-wider">ROOTS</span></div>
                <div class="text-center mb-10"><span class="text-stone-400 text-sm uppercase tracking-widest block mb-2">Find the ${State.tempData.mode === 'syn' ? 'Synonym' : 'Antonym'} for</span><div class="text-4xl font-serif font-bold text-stone-800 border-b-2 border-stone-200 pb-4 px-8 inline-block">${target.w}</div></div>
                <div class="grid grid-cols-2 gap-4 w-full max-w-lg" id="opts"></div>
            `;
            const grid = div.querySelector('#opts');
            State.tempData.options.forEach(opt => {
                 const btn = document.createElement('button');
                 let cls = "bg-white border-stone-200 hover:border-purple-300";
                 if (State.tempData.feedback !== null) {
                     if (opt === State.tempData.correct) cls = "bg-green-100 border-green-500 text-green-800"; else cls = "opacity-50";
                 }
                 btn.className = `p-6 rounded-xl border-2 text-lg font-bold transition-all ${cls}`;
                 btn.innerText = opt;
                 btn.onclick = () => {
                     if (State.tempData.feedback !== null) return;
                     const isCorrect = opt === State.tempData.correct;
                     State.tempData.feedback = isCorrect; render();
                     if (isCorrect) { setTimeout(() => { State.queue.shift(); updatePersistentQueue(); State.tempData = null; checkVictory() || render(); }, 1500);
                     } else { setTimeout(() => { const moved = State.queue.shift(); State.queue.push(moved); updatePersistentQueue(); State.tempData = null; State.feedback = null; render(); }, 2000); }
                 };
                 grid.appendChild(btn);
            });
            div.querySelector('#back-btn').onclick = () => { State.view = 'menu'; render(); };
            App.appendChild(div);
        }

        render();

        document.addEventListener('keydown', (e) => {
            if (State.view === 'workshop' && !State.feedback) {
                const key = e.key.toLowerCase();
                const buttons = Array.from(document.querySelectorAll('#tiles-area button'));
                const match = buttons.find(b => b.innerText.toLowerCase() === key);
                if (match) match.click();
            }
        });

    </script>
</body>
</html>
